{% extends "base.html" %}
{% block title %}{{ novel.title }}{% endblock %}
{% block content %}

<div class="novel-detail-grid">

    <div class="novel-detail-left">
        <div class="novel-cover">
            {% if novel.cover_image %}
                <img src="{{ novel.cover_image }}" alt="{{ novel.title }}">
            {% else %}
                <div class="cover-placeholder"><span>{{ novel.title }}</span></div>
            {% endif %}
        </div>
        <div class="novel-metadata">
            <ul>
                <li><span class="meta-icon">üë§</span><strong>T√°c gi·∫£:</strong> {{ novel.author or 'Ch∆∞a c·∫≠p nh·∫≠t' }}</li>
                <li><span class="meta-icon">üè∑Ô∏è</span><strong>Th·ªÉ lo·∫°i:</strong> 
                    {% if novel.tags %}
                        {{ novel.tags|map(attribute='name')|join(', ') }}
                    {% else %}
                        Ch∆∞a ph√¢n lo·∫°i
                    {% endif %}
                </li>
                </ul>
        </div>
    </div>

    <div class="novel-detail-right">
    <h1>{{ novel.title }}</h1>

    <div class="summary">
        <h3>T√ìM T·∫ÆT</h3>
        <p>{{ novel.description or 'Truy·ªán ch∆∞a c√≥ m√¥ t·∫£.' }}</p>
    </div>

    <div class="novel-actions">
        
        {% if first_chapter_id %}
            <a href="{{ url_for('read_chapter', chapter_id=first_chapter_id) }}" class="btn btn-primary">ƒê·ªçc t·ª´ ƒë·∫ßu</a>
        {% endif %}

        {% if first_chapter_id %}
             <a href="{{ url_for('read_chapter', chapter_id=first_chapter_id) }}" class="btn btn-secondary" id="continue-reading-btn">ƒê·ªçc ti·∫øp</a>
        {% endif %}

        {% if last_chapter_id %}
            <a href="{{ url_for('read_chapter', chapter_id=last_chapter_id) }}" class="btn btn-success">ƒê·ªçc ch∆∞∆°ng cu·ªëi</a>
        {% endif %}
        
    </div>
</div>

<hr>

<div class="chapter-list" id="chapter-list"> <h2>Danh s√°ch ch∆∞∆°ng</h2>
    <table>
        <tbody>
            {% for chapter in chapters %}
            <tr>
                <td data-label="Ch∆∞∆°ng {{ chapter.chapter_number }}">
                    <a href="{{ url_for('read_chapter', chapter_id=chapter.id) }}">
                        Ch∆∞∆°ng {{ chapter.chapter_number }}: {{ chapter.title }}
                    </a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td>Ch∆∞a c√≥ ch∆∞∆°ng n√†o.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% block scripts %}
<script>
    // Khi trang chi ti·∫øt truy·ªán ƒë∆∞·ª£c t·∫£i, ki·ªÉm tra ti·∫øn tr√¨nh ƒë√£ l∆∞u
    document.addEventListener('DOMContentLoaded', function() {
        const novelId = {{ novel.id }};
        const continueBtn = document.getElementById('continue-reading-btn');
        
        if (continueBtn) {
            // L·∫•y to√†n b·ªô ti·∫øn tr√¨nh ƒë·ªçc t·ª´ localStorage
            const readingProgress = JSON.parse(localStorage.getItem('readingProgress')) || {};
            
            // L·∫•y ID ch∆∞∆°ng cu·ªëi c√πng ƒë√£ ƒë·ªçc c·ªßa ri√™ng truy·ªán n√†y
            const lastReadChapterId = readingProgress[novelId];
            
            if (lastReadChapterId) {
                // N·∫øu c√≥, c·∫≠p nh·∫≠t l·∫°i link c·ªßa n√∫t "ƒê·ªçc ti·∫øp"
                continueBtn.href = `/chapter/${lastReadChapterId}`;
                console.log(`ƒê√£ t√¨m th·∫•y ti·∫øn tr√¨nh: Ch∆∞∆°ng cu·ªëi ƒë√£ ƒë·ªçc l√† ${lastReadChapterId}. C·∫≠p nh·∫≠t n√∫t 'ƒê·ªçc ti·∫øp'.`);
            } else {
                console.log('Ch∆∞a c√≥ ti·∫øn tr√¨nh ƒë·ªçc cho truy·ªán n√†y.');
            }
        }
    });
</script>
{% endblock %}

{% endblock %}